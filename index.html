<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Data Visualization</title>
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <style>
        .line {
            fill: none;
            stroke-width: 2px;
        }
        .cases {
            stroke: steelblue;
        }
        .deaths {
            stroke: firebrick;
        }
        .hospitalizations {
            stroke: green;
        }
        .axis-label {
            font-size: 12px;
        }
        .legend {
            font-size: 12px;
        }
        .grid-line {
            stroke: lightgrey;
            stroke-opacity: 0.5;
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }
        .x-axis-year .tick line {
            stroke: none;
        }
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .order-line {
            stroke: red;
            stroke-width: 2px;
            stroke-dasharray: 4;
        }
        .highlight {
            stroke: blue;
            stroke-width: 6px;
            stroke-dasharray: none;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .button-container button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
        .order-list {
            margin-top: 20px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .order-item {
            cursor: pointer;
            margin: 5px;
            padding: 5px;
            border: 1px solid #ccc;
            display: inline-block;
            width: 200px;
        }
        .order-description {
            display: none;
            margin-top: 10px;
        }
        .dropdown-container {
            text-align: center;
            margin-top: 20px;
        }
        .community-info {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>City of Chicago Covid 19 Orders and Their Effects</h1>
    <p>Click on any year to see the hospitalizations, cases, and deaths due to SARS-COV 19 in the city of Chicago. After clicking on a year, the city COVID-19 orders for that year will be
    will be shown below the graph. Click on any order to see it highlighted on the graph and details of the order. Alternatively click on "By Neighborhood" to see the hospitalizations, cases, and deaths due to SARS-COV 19 
    for each community area in Chicago, from there a year can be selected and COVID orders can be highlighted.</p>
    <div class="dropdown-container">
        <label for="community-dropdown">Select Community Area: </label>
        <select id="community-dropdown">
            <option value="">--Select--</option>
        </select>
    </div>
    <div class="community-info"></div>
    <div class="button-container">
        <button id="btn-all">All Years</button>
    </div>
    <div class="button-container">
        <button id="btn-2020">2020</button>
        <button id="btn-2021">2021</button>
        <button id="btn-2022">2022</button>
        <button id="btn-2023">2023</button>
    </div>
    <svg width="100%" height="600"></svg>
    <div class="order-list"></div>
    <script>
        // URLs of the datasets
        const covidDataUrl = "https://data.cityofchicago.org/resource/naz8-j4nc.json?$select=lab_report_date,cases_total,deaths_total,hospitalizations_total&$limit=5000";
        const ordersUrl = "covid19_orders.csv";
        const communityDataUrl = "https://data.cityofchicago.org/resource/xhc6-88s9.json";

        // Fetch the data
        Promise.all([
            d3.json(covidDataUrl),
            d3.csv(ordersUrl),
            d3.json(communityDataUrl)
        ]).then(([covidData, orders, communityData]) => {
            // Parse the date and convert totals to numbers
            covidData.forEach(d => {
                d.lab_report_date = new Date(d.lab_report_date);
                d.cases_total = +d.cases_total;
                d.deaths_total = +d.deaths_total;
                d.hospitalizations_total = +d.hospitalizations_total;
            });

            // Parse the orders data
            orders.forEach(order => {
                order.Date = new Date(order.Date);
            });

            // Populate the dropdown menu with community area names
            const dropdown = d3.select("#community-dropdown");
            communityData
                .filter(community => community.community_area_name)
                .forEach(community => {
                dropdown.append("option")
                    .attr("value", community.community_area_name)
                    .text(community.community_area_name);
            });

            // Display community information when a community is selected
            dropdown.on("change", function() {
                const selectedCommunity = this.value;
                const communityInfo = communityData.find(c => c.community_area_name === selectedCommunity);
                if (communityInfo) {
                    d3.select(".community-info").html(`
                        <p><strong>Community Area:</strong> ${communityInfo.community_area_name}</p>
                        <p><strong>Rank Socioeconomic Status:</strong> ${communityInfo.rank_socioeconomic_status}</p>
                        <p><strong>CCVI Score:</strong> ${communityInfo.ccvi_score}</p>
                    `);
                } else {
                    d3.select(".community-info").html("");
                }
            });

            // Aggregate data by month
            const monthlyData = d3.nest()
                .key(d => d3.timeMonth(d.lab_report_date))
                .rollup(values => ({
                    lab_report_date: d3.timeMonth(values[0].lab_report_date),
                    cases_total: d3.sum(values, d => d.cases_total),
                    deaths_total: d3.sum(values, d => d.deaths_total),
                    hospitalizations_total: d3.sum(values, d => d.hospitalizations_total)
                }))
                .entries(covidData)
                .map(d => d.value)
                .sort((a, b) => a.lab_report_date - b.lab_report_date);

            // Function to update the chart based on the selected year
            function updateChart(year) {
                // Filter data for the selected year or show all data
                const filteredData = year === "all" ? monthlyData : monthlyData.filter(d => d.lab_report_date.getFullYear() === year);

                // Clear the SVG container
                d3.select("svg").html("");

                // Set up the SVG canvas dimensions
                const svg = d3.select("svg");
                const margin = { top: 20, right: 150, bottom: 40, left: 50 };
                const width = svg.node().getBoundingClientRect().width - margin.left - margin.right;
                const height = +svg.attr("height") - margin.top - margin.bottom - 10;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                // Create scales
                const x = d3.scaleTime().range([0, width]);
                const y = d3.scaleLog().base(10).range([height, 0]);

                // Set the domains for the scales
                const xDomain = d3.extent(filteredData, d => d.lab_report_date);
                xDomain[1] = d3.timeMonth.offset(xDomain[1], 1); // Extend the domain to include the entire month of December
                x.domain(xDomain);
                y.domain([1, d3.max(filteredData, d => Math.max(d.cases_total, d.deaths_total, d.hospitalizations_total))]);

                // Create axes
                const xAxis = d3.axisBottom(x)
                    .ticks(d3.timeMonth.every(1))
                    .tickFormat(d3.timeFormat("%b"))
                    .tickPadding(10);

                const yAxis = d3.axisLeft(y)
                    .tickValues([1, 10, 100, 1000, 10000, 100000])
                    .tickFormat(d3.format("~s"))
                    .tickPadding(10);

                // Append the axes
                g.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis);

                g.append("g")
                    .attr("class", "y-axis")
                    .call(yAxis);

                // Create line generators
                const lineCases = d3.line()
                    .x(d => x(d.lab_report_date))
                    .y(d => y(d.cases_total));

                const lineDeaths = d3.line()
                    .x(d => x(d.lab_report_date))
                    .y(d => y(d.deaths_total));

                const lineHospitalizations = d3.line()
                    .x(d => x(d.lab_report_date))
                    .y(d => y(d.hospitalizations_total));

                // Append the lines
                g.append("path")
                    .datum(filteredData)
                    .attr("class", "line cases")
                    .attr("d", lineCases);

                g.append("path")
                    .datum(filteredData)
                    .attr("class", "line deaths")
                    .attr("d", lineDeaths);

                g.append("path")
                    .datum(filteredData)
                    .attr("class", "line hospitalizations")
                    .attr("d", lineHospitalizations);

                // Add axis labels
                svg.append("text")
                    .attr("class", "axis-label")
                    .attr("transform", `translate(${width / 2 + margin.left},${height + margin.top + 50})`)
                    .style("text-anchor", "middle")
                    .text("Date");

                svg.append("text")
                    .attr("class", "axis-label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", margin.left - 40)
                    .attr("x", 0 - (height / 2 + margin.top))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Total");

                // Add legend
                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width + 60},${margin.top})`);

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "steelblue");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 10)
                    .text("Cases");

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 20)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "red");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 30)
                    .text("Deaths");

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 40)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "green");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 50)
                    .text("Hospitalizations");

                // Add dashed red line to the legend
                legend.append("line")
                    .attr("x1", 0)
                    .attr("y1", 70)
                    .attr("x2", 10)
                    .attr("y2", 70)
                    .attr("class", "order-line");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 75)
                    .text("COVID-19 Orders");

                // Add year labels to the x-axis
                g.append("g")
                    .attr("class", "x-axis-year")
                    .attr("transform", `translate(0,${height + 5})`)
                    .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")).tickSize(10).tickPadding(10));

                // Create a tooltip
                const tooltip = d3.select("body").append("div")	
                    .attr("class", "tooltip")				
                    .style("opacity", 0);

                // Add invisible rectangles for each month section
                g.selectAll(".month-rect")
                    .data(filteredData)
                    .enter().append("rect")
                    .attr("class", "month-rect")
                    .attr("x", d => x(d.lab_report_date))
                    .attr("y", 0)
                    .attr("width", width / filteredData.length)
                    .attr("height", height)
                    .attr("fill", "none")
                    .attr("pointer-events", "all")
                    .on("mouseover", (d, i) => {
                        tooltip.style("opacity", 1)
                            .html(`Date: ${d3.timeFormat("%B %Y")(d.lab_report_date)}<br>
                                   Cases: ${d.cases_total}<br>
                                   Deaths: ${d.deaths_total}<br>
                                   Hospitalizations: ${d.hospitalizations_total}`)
                            .style("left", `${event.pageX + 10}px`)
                            .style("top", `${event.pageY + 10}px`);
                    })
                    .on("mouseout", () => {
                        tooltip.style("opacity", 0);
                    });

                // Add red vertical lines for each order date in the selected year
                if (year !== "all") {
                    g.selectAll(".order-line")
                        .data(orders.filter(d => d.Date.getFullYear() === year))
                        .enter().append("line")
                        .attr("class", "order-line")
                        .attr("x1", d => x(d.Date))
                        .attr("x2", d => x(d.Date))
                        .attr("y1", 0)
                        .attr("y2", height);
                } else {
                    const orderMonths = new Set(orders.map(d => d3.timeMonth(d.Date).getTime()));
                    g.selectAll(".order-line")
                        .data(filteredData.filter(d => orderMonths.has(d.lab_report_date.getTime())))
                        .enter().append("line")
                        .attr("class", "order-line")
                        .attr("x1", d => x(d.lab_report_date))
                        .attr("x2", d => x(d.lab_report_date))
                        .attr("y1", 0)
                        .attr("y2", height);
                }

                // Display order list for the selected year
                if (year !== "all") {
                    const filteredOrders = orders
                        .filter(order => order.Date.getFullYear() === year)
                        .sort((a, b) => a.Date - b.Date);
                    const orderList = d3.select(".order-list").html("");

                    filteredOrders.forEach(order => {
                        const orderItem = orderList.append("div")
                            .attr("class", "order-item")
                            .text(`${order.Title} (${d3.timeFormat("%B %d, %Y")(order.Date)})`)
                            .on("click", function() {
                                d3.selectAll(".order-description").style("display", "none");
                                d3.select(this).select(".order-description").style("display", "block");

                                // Highlight the corresponding order line on the graph
                                g.selectAll(".order-line").classed("highlight", false);
                                g.selectAll(".order-line")
                                    .filter(d => d.Date && d.Date.getTime() === order.Date.getTime())
                                    .classed("highlight", true);
                            });

                        orderItem.append("div")
                            .attr("class", "order-description")
                            .text(order.Details);
                    });
                } else {
                    d3.select(".order-list").html("");
                }
            }

            // Initial chart display for all years
            updateChart("all");

            // Add event listeners to the buttons
            d3.select("#btn-all").on("click", () => updateChart("all"));
            d3.select("#btn-2020").on("click", () => updateChart(2020));
            d3.select("#btn-2021").on("click", () => updateChart(2021));
            d3.select("#btn-2022").on("click", () => updateChart(2022));
            d3.select("#btn-2023").on("click", () => updateChart(2023));
        });
    </script>
</body>
</html>
